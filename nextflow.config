// enable DSL2
nextflow.enable.dsl = 2

/* quick test (local docker):
   nextflow run main.nf \
     --verbose \
     --samples "test_samples/*.fasta" \
     --outdir "results_test" \
     -profile docker
*/

// Parameters
params {
  reference_fasta       = "raw_data/NC_045512.2_sequence.fasta"
  train_feature_matrix  = "lasso_training_data/feature_matrix_train.csv"
  model                 = "model_artifacts/lasso_model.joblib"
  scaler                = "model_artifacts/scaler.joblib"
  chunk_size            = 10
  identity_thresh       = 92.0
  params.verbose        = false
}

process {
  executor = 'local'
  maxForks = 10
}

/* ---------- Conda baseline (what you already had) ---------- */
conda {
  enabled  = true
  useMamba = true
}

profiles {
  standard {
    conda.enabled  = true
    conda.useMamba = true
  }

  aws {
    process {
      executor = 'awsbatch'
      maxForks = 50
    }
    conda.enabled  = true
    conda.useMamba = true
  }

  /* ---------- NEW: local Docker profile (one image for all processes) ---------- */
  docker {
    docker.enabled    = true
    docker.runOptions = '-u $(id -u):$(id -g)'  // avoid root-owned outputs
    conda.enabled     = false                   // containers supply the env

    // one container for every process
    process.container = 'achandrasek6/covid-lasso:0.1'
  }

  /* ---------- NEW: AWS Batch + Docker images ---------- */
  aws_docker {
    process {
      executor = 'awsbatch'
      maxForks = 50
      // if you push the same image to ECR, use that URI here:
      // process.container = 'ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/covid-lasso:0.1'
      container = 'achandrasek6/covid-lasso:0.1'
    }
    conda.enabled = false
    // Optional: enable Fusion for faster I/O on AWS if configured
    // fusion { enabled = true }
  }
}
